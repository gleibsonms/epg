name: BR Generate EPG (Local M3U with suggestions & safe commit)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Ajuste se quiser rodar automaticamente (UTC)

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      OUT_FILE: epg.xml
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run generator with local M3U
        id: run_generator
        env:
          EPG_URL: ${{ secrets.EPG_URL }}
        run: |
          echo "Using local M3U: lista.m3u"
          if [ -n "$EPG_URL" ]; then
            echo "EPG_URL provided. Trying to merge with: $EPG_URL"
            python epg_generator.py --m3u lista.m3u --epg "$EPG_URL" --out "$OUT_FILE" --tz-offset -3 || echo "Generator returned non-zero"
          else
            echo "No EPG_URL provided. Generating placeholders from local M3U"
            python epg_generator.py --m3u lista.m3u --out "$OUT_FILE" --tz-offset -3 || echo "Generator returned non-zero"
          fi

      - name: Debug: count channels/programmes and preview
        run: |
          echo "PWD: $(pwd)"
          echo "== Listing files =="
          ls -la
          echo
          echo "== Counts =="
          echo "channels:" $(grep -c "<channel " epg.xml || echo "0")
          echo "programmes:" $(grep -c "<programme " epg.xml || echo "0")
          echo
          echo "== Placeholder check (first 10) =="
          grep -n "Programa Exemplo" epg.xml | head -n 10 || echo "No placeholders found"
          echo
          echo "== Preview (first 120 lines) =="
          head -n 120 epg.xml || echo "epg.xml not found"
          echo
          echo "== First 40 programme contexts =="
          awk 'BEGIN{c=0} /<programme /{print; getline; print; getline; print; c++; if(c>=40) exit}' epg.xml || true

      - name: Generate channel_map_suggestions.json (artifact)
        run: |
          python - <<'PY'
          import requests, gzip, xml.etree.ElementTree as ET, json, os
          from difflib import get_close_matches
          def normalize(s):
              return ''.join(ch for ch in (s or "").lower() if ch.isalnum())
          m3u = "lista.m3u"
          epg_url = "${{ secrets.EPG_URL }}" or "https://iptv-org.github.io/epg/guides/br.xml"
          # load m3u ids (use tvg-id if present else normalized name)
          m3u_ids = []
          if os.path.exists(m3u):
              with open(m3u,"r",encoding="utf-8",errors="ignore") as f:
                  for line in f:
                      if line.startswith("#EXTINF"):
                          if 'tvg-id="' in line:
                              try:
                                  tid = line.split('tvg-id="',1)[1].split('"',1)[0]
                              except:
                                  tid = None
                          else:
                              tid = None
                          name = line.split(",",1)[-1].strip()
                          m3u_ids.append(tid if tid else normalize(name))
          m3u_norm = {normalize(x): x for x in m3u_ids}
          # load epg channels
          try:
              r = requests.get(epg_url, timeout=30)
              data = r.content
              if epg_url.endswith(".gz") or (len(data)>=2 and data[:2]==b'\x1f\x8b'):
                  data = gzip.decompress(data)
              root = ET.fromstring(data)
          except Exception as e:
              print("Could not load remote EPG:", e)
              root = None
          epg_channels = {}
          if root is not None:
              for ch in root.findall('channel'):
                  cid = ch.attrib.get('id','')
                  dn = ch.find('display-name')
                  epg_channels[cid] = (dn.text if dn is not None else '')
          suggest = {}
          for cid, dn in epg_channels.items():
              n1 = normalize(cid)
              n2 = normalize(dn)
              cand = None
              if n1 in m3u_norm:
                  cand = m3u_norm[n1]
              elif n2 in m3u_norm:
                  cand = m3u_norm[n2]
              else:
                  keys = list(m3u_norm.keys())
                  matches = get_close_matches(n1, keys, n=1, cutoff=0.7)
                  if not matches:
                      matches = get_close_matches(n2, keys, n=1, cutoff=0.7)
                  if matches:
                      cand = m3u_norm[matches[0]]
              if cand:
                  suggest[cid] = cand
          with open("channel_map_suggestions.json","w",encoding="utf-8") as f:
              json.dump(suggest,f,indent=2,ensure_ascii=False)
          print("Generated channel_map_suggestions.json with", len(suggest), "suggestions")
          PY

      - name: Upload suggestions artifact
        uses: actions/upload-artifact@v4
        with:
          name: channel-map-suggestions
          path: channel_map_suggestions.json

      - name: Compare generated epg with remote and commit if different
        env:
          REPO_RAW: https://raw.githubusercontent.com/${{ github.repository }}/main/epg.xml
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Downloading remote epg for comparison..."
          if curl -s -f "$REPO_RAW" -o /tmp/remote_epg.xml; then
            echo "Remote epg downloaded."
            if cmp -s epg.xml /tmp/remote_epg.xml; then
              echo "No differences found. No commit will be made."
              exit 0
            else
              echo "Differences detected. Will commit new epg.xml."
            fi
          else
            echo "Could not download remote epg (it may not exist). Will commit generated epg.xml."
          fi

          # Optional: if you want to force commit even if identical, uncomment the following:
          # echo "<!-- updated: $(date -u +'%Y-%m-%dT%H:%M:%SZ') -->" >> epg.xml

          git add epg.xml
          git commit -m "üîÅ Atualiza EPG (autom√°tico) $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "git commit returned non-zero (maybe nothing to commit)"
          echo "Pushing changes..."
          git push origin HEAD:main

      - name: Final status (last commits)
        run: |
          echo "Last commits:"
          git --no-pager log -n 5 --pretty=format:"%h %ad %s" --date=iso
