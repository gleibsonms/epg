name: üáßüá∑ BR Generate EPG (Local M3U, compare & commit)

# Run manually or on schedule
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # ajusta se quiser outro hor√°rio

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      OUT_FILE: epg.xml
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # garante que o GITHUB_TOKEN seja usado para push

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Rodar gerador com arquivo local
        id: run_generator
        env:
          EPG_URL: ${{ secrets.EPG_URL }}
        run: |
          echo "Usando lista local: lista.m3u"
          if [ -n "$EPG_URL" ]; then
            echo "EPG_URL definido ‚Äî o script tentar√° mesclar com: $EPG_URL"
            python epg_generator.py --m3u lista.m3u --epg "$EPG_URL" --out "$OUT_FILE" --tz-offset -3 || echo "Gerador retornou n√£o-zero mas continuando"
          else
            echo "EPG_URL n√£o definido ‚Äî gerando placeholders a partir da lista local"
            python epg_generator.py --m3u lista.m3u --out "$OUT_FILE" --tz-offset -3 || echo "Gerador retornou n√£o-zero mas continuando"
          fi

      - name: Verificar sa√≠da e listar arquivos
        run: |
          echo "PWD: $(pwd)"
          echo "Lista de arquivos no diret√≥rio:"
          ls -la
          echo
          echo "Preview do arquivo gerado (primeiras 120 linhas):"
          head -n 120 epg.xml || echo "epg.xml nao encontrado"
          echo
          echo "Tamanho do arquivo (bytes):"
          wc -c epg.xml || true

      - name: Comparar epg gerado com epg remoto e commitar se diferente
        env:
          REPO_RAW: https://raw.githubusercontent.com/${{ github.repository }}/main/epg.xml
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Tentando baixar epg remoto para compara√ß√£o..."
          if curl -s -f "$REPO_RAW" -o /tmp/remote_epg.xml; then
            echo "EPG remoto baixado com sucesso. Comparando arquivos..."
            if cmp -s epg.xml /tmp/remote_epg.xml; then
              echo "Sem diferen√ßas detectadas. N√£o ser√° feito commit."
              exit 0
            else
              echo "Diferen√ßa detectada ‚Äî faremos commit do novo epg.xml."
            fi
          else
            echo "EPG remoto n√£o encontrado ou erro no download. Iremos commitar o epg_local."
          fi

          # Opcional: adicionar metadados (n√£o requerido) -- comentar se n√£o quiser
          # echo "<!-- updated: $(date -u +'%Y-%m-%dT%H:%M:%SZ') -->" >> epg.xml

          git add epg.xml
          git commit -m "üîÅ Atualiza EPG (autom√°tico) $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "git commit retornou erro (possivelmente sem mudan√ßas reais)"
          echo "Pushing changes..."
          # push usando token via checkout persist-credentials
          git push origin HEAD:main

      - name: Confirmar estado final
        run: |
          echo "Estado final do reposit√≥rio (√∫ltimos commits):"
          git --no-pager log -n 3 --pretty=format:"%h %ad %s" --date=iso

