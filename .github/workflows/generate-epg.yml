name: Generate EPG (Auto-safe)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # opcional: roda todo dia 02:00 UTC

jobs:
  generate-epg:
    runs-on: ubuntu-latest

    # traz os secrets para dentro do ambiente do job (vazios se não configurados)
    env:
      EPG_URL: ${{ secrets.EPG_URL }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Show repository files (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Try download EPG remote (if env set)
        run: |
          if [ -n "$EPG_URL" ]; then
            echo "Baixando EPG remoto de: $EPG_URL"
            curl -fsSL "$EPG_URL" -o epg_remote.xml
            echo "epg_remote.xml size:"
            wc -c epg_remote.xml || true
          else
            echo "EPG_URL não definido; pulando download de EPG remoto."
          fi

      - name: Try download M3U remote (if env set)
        run: |
          if [ -n "$M3U_URL" ]; then
            echo "Baixando M3U remoto de: $M3U_URL"
            curl -fsSL "$M3U_URL" -o lista.m3u
            echo "lista.m3u size:"
            wc -c lista.m3u || true
          else
            echo "M3U_URL não definido; esperando arquivo lista.m3u no repositório."
          fi

      - name: Install requirements if present
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "Nenhum requirements.txt; pulando instalação."
          fi

      - name: Run EPG generator
        run: |
          # Escolhe o EPG de entrada: remoto (se baixado) ou epg.xml do repo
          if [ -f epg_remote.xml ]; then
            EPG_IN="epg_remote.xml"
          else
            EPG_IN="epg.xml"
          fi
          echo "Usando EPG input: $EPG_IN"

          # Verifica se lista.m3u existe (baixada ou no repo)
          if [ ! -f lista.m3u ]; then
            echo "::error::Arquivo lista.m3u não encontrado. Coloque lista.m3u no repo ou configure M3U_URL secret."
            exit 2
          fi

          # Roda o gerador disponível (prioriza epg_generator_auto.py)
          if [ -f epg_generator_auto.py ]; then
            echo "Executando epg_generator_auto.py"
            python3 epg_generator_auto.py --m3u lista.m3u --epg "$EPG_IN" --out epg.xml
            rc=$?
          elif [ -f epg_generator.py ]; then
            echo "Executando epg_generator.py"
            python3 epg_generator.py --m3u lista.m3u --epg "$EPG_IN" --out epg.xml
            rc=$?
          else
            echo "::error::Nenhum script gerador encontrado (epg_generator_auto.py ou epg_generator.py)."
            exit 3
          fi

          echo "Exit code do gerador: $rc"
          if [ "$rc" -ne 0 ]; then
            exit $rc
          fi

      - name: Preview generated EPG (first 80 lines)
        if: always()
        run: |
          echo "----- PREVIEW epg.xml -----"
          head -n 80 epg.xml || true

      - name: Commit and push epg.xml if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add epg.xml || true
          if git diff --cached --quiet; then
            echo "Sem alterações para commitar."
          else
            git commit -m "Atualiza epg.xml (automático) [ci]" || true
            git push origin HEAD:main
          fi

      - name: Finished
        run: echo "Workflow finalizado."
