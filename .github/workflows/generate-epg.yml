name: Generate EPG

on:
  schedule:
    # Executa a cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show workspace (debug)
        run: |
          echo "Working directory: $(pwd)"
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run generator using local lista.m3u and remote EPG
        env:
          EPG_URL: ${{ secrets.EPG_URL }}
        run: |
          echo "=== Etapa: Preparando EPG ==="
          echo "EPG_URL length: ${#EPG_URL}"

          # Confere se a lista.m3u existe
          if [ ! -f lista.m3u ]; then
            echo "ERRO: arquivo lista.m3u não encontrado no repositório!"
            ls -la
            exit 2
          fi

          # Baixa o EPG remoto com curl e user-agent de navegador
          echo "Baixando EPG remoto de $EPG_URL ..."
          curl -sSL -A "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0" \
            "$EPG_URL" -o epg_remote.xml

          # Verifica se o arquivo foi baixado corretamente
          if [ ! -s epg_remote.xml ]; then
            echo "❌ Falha ao baixar o EPG remoto (arquivo vazio ou não salvo)."
            ls -la epg_remote.xml || true
            exit 2
          fi

          echo "Arquivo EPG baixado com sucesso:"
          ls -lh epg_remote.xml

          # Executa o gerador (usa arquivo local do EPG baixado)
          echo "Executando gerador de EPG..."
          python epg_generator.py lista.m3u --epg-source epg_remote.xml --out epg.xml

      - name: Show beginning of generated epg (debug)
        run: |
          echo "Prévia do arquivo gerado:"
          head -n 80 epg.xml || true

      - name: Commit EPG file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add epg.xml
          git commit -m "Automated EPG update" || echo "Nenhuma alteração a commitar"
          git push
