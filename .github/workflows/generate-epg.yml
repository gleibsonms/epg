name: Generate EPG

on:
  workflow_dispatch:

permissions:
  contents: write   # necessário para commitar epg.xml

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      # timezone usado pelo gerador (ajuste se precisar)
      TZ: "UTC"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Show repository files (debug)
      run: |
        echo "PWD: $(pwd)"
        echo "Lista de arquivos no diretório:"
        ls -la

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install requirements (none needed by default)
      run: |
        if [ -f requirements.txt ]; then
          python -m pip install -r requirements.txt
        else
          echo "no requirements.txt found — skipping install"
        fi

    - name: Try download EPG remote (if secret set)
      shell: bash
      run: |
        set -e
        if [ -n "${{ secrets.EPG_URL }}" ]; then
          echo "EPG_URL definido. Tentando baixar EPG remoto..."
          # baixa para epg_remote.xml
          if curl -fsSL "${{ secrets.EPG_URL }}" -o epg_remote.xml; then
            echo "EPG remoto baixado: epg_remote.xml"
          else
            echo "Falha ao baixar EPG remoto (status não 2xx). Removendo epg_remote.xml se existir."
            rm -f epg_remote.xml || true
          fi
        else
          echo "EPG_URL não definido — pulando download EPG remoto."
        fi

    - name: Try download M3U remote (if secret set)
      shell: bash
      run: |
        set -e
        if [ -n "${{ secrets.M3U_URL }}" ]; then
          echo "M3U_URL definido. Baixando lista m3u..."
          if curl -fsSL "${{ secrets.M3U_URL }}" -o lista.m3u; then
            echo "Lista M3U baixada para lista.m3u"
          else
            echo "Falha ao baixar M3U remoto. Removendo lista.m3u && esperando lista local."
            rm -f lista.m3u || true
          fi
        else
          echo "M3U_URL não definido — esperando lista.m3u no repositório."
        fi

    - name: Choose source EPG
      shell: bash
      run: |
        # prioridade:
        # 1) epg_remote.xml (baixado do secret EPG_URL)
        # 2) epg.xml (arquivo no repositório)
        if [ -f epg_remote.xml ]; then
          echo "Usando source: epg_remote.xml"
          export SOURCE_EPG="epg_remote.xml"
        elif [ -f epg.xml ]; then
          echo "epg_remote.xml não encontrado. Usando epg.xml do repositório como referência (ATENÇÃO: se o gerador ler o mesmo arquivo como fonte, pode não mudar)."
          export SOURCE_EPG="epg.xml"
        else
          echo "Nenhum EPG fonte encontrado (epg_remote.xml ou epg.xml). Saindo com erro."
          exit 1
        fi
        echo "source=$SOURCE_EPG" > /tmp/epg_source.txt
        cat /tmp/epg_source.txt

    - name: Run EPG generator (local M3U)
      shell: bash
      run: |
        set -e
        echo "Rodando gerador com source: $(cat /tmp/epg_source.txt)"
        SOURCE=$(cat /tmp/epg_source.txt | cut -d'=' -f2)
        # nome do script: epg_generator.py (certifique-se de que esse arquivo exista na raiz)
        if [ ! -f epg_generator.py ]; then
          echo "Arquivo epg_generator.py não encontrado na raiz do repositório. Coloque o script com esse nome."
          exit 2
        fi

        # argumentos: --m3u lista.m3u --epg <source> --out epg.xml
        # Ajuste as flags do seu gerador caso seu script use nomes diferentes.
        python3 epg_generator.py --m3u lista.m3u --epg "$SOURCE" --out epg.xml || {
          echo "Erro: gerador retornou código != 0"
          exit 3
        }

    - name: Preview generated EPG (first 80 lines)
      if: always()
      run: |
        echo "Preview (first 80 lines) of generated epg.xml"
        head -n 80 epg.xml || true

    - name: Commit and push epg.xml if changed
      run: |
        set -e
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add epg.xml || true
        if ! git diff --staged --quiet; then
          git commit -m "Atualiza epg.xml (automático)" || true
          git push origin HEAD:main || true
          echo "epg.xml atualizado e enviado."
        else
          echo "Sem alterações para commitar."
        fi
