name: Generate EPG

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repository files (debug)
        run: ls -la

      - name: Try download EPG remote (if env set)
        run: |
          set -e
          if [ -n "${{ secrets.EPG_URL }}" ]; then
            echo "EPG_URL definido. Tentando baixar EPG remoto..."
            echo "***" "${{ secrets.EPG_URL }}" "***"
            if curl -f -L -s -o epg_remote.xml "${{ secrets.EPG_URL }}"; then
              echo "EPG remoto salvo em epg_remote.xml"
            else
              echo "Falha ao baixar EPG remoto (status não 2xx). Removendo epg_remote.xml se existir."
              rm -f epg_remote.xml || true
            fi
          else
            echo "EPG_URL não definido - pulando download remoto."
          fi

      - name: Try download M3U remote (if env set)
        run: |
          set -e
          if [ -n "${{ secrets.M3U_URL }}" ]; then
            echo "M3U_URL definido. Tentando baixar M3U remoto..."
            if curl -f -L -s -o lista.m3u "${{ secrets.M3U_URL }}"; then
              echo "M3U salvo em lista.m3u"
            else
              echo "Falha ao baixar M3U remoto."
              exit 1
            fi
          else
            echo "M3U_URL não definido - usando lista.m3u no repositório."
          fi

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements (none needed, stdlib used)
        run: python3 -V

      - name: Choose source EPG
        id: choose_epg
        run: |
          if [ -f epg_remote.xml ]; then
            echo "source=epg_remote.xml" >> "$GITHUB_OUTPUT"
          elif [ -f epg.xml ]; then
            echo "source=epg.xml" >> "$GITHUB_OUTPUT"
          else
            echo "source=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run EPG generator (local M3U)
        run: |
          set -e
          SRC="${{ steps.choose_epg.outputs.source }}"
          if [ -z "$SRC" ]; then
            echo "Nenhum EPG fonte encontrado. Saindo com erro."
            exit 1
          fi
          echo "Rodando gerador com source: $SRC"
          python3 epg_generator_auto.py --m3u lista.m3u --epg "$SRC" --out epg.xml --threshold 0.72

      - name: Preview generated EPG (first 80 lines)
        if: always()
        run: head -n 80 epg.xml || true

      - name: Commit and push epg.xml if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add epg.xml || true
          if git diff --cached --quiet; then
            echo "Sem alterações para commitar"
          else
            git commit -m "Atualiza epg.xml (automático)"
            git push
          fi
