name: Generate EPG

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Show repo files (debug)
        run: ls -la

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # optional: try download EPG remote if you set a secret EPG_URL
      - name: Try download EPG remote (if secret set)
        if: ${{ secrets.EPG_URL != '' }}
        run: |
          set -e
          echo "EPG_URL definido. Tentando baixar EPG remoto..."
          curl -sS -f "${{ secrets.EPG_URL }}" -o epg_remote.xml || { echo "Falha ao baixar EPG remoto (status nÃ£o 2xx). Removendo epg_remote.xml se existir."; rm -f epg_remote.xml; }

      # optional: try download M3U remote if you set a secret M3U_URL
      - name: Try download M3U remote (if secret set)
        if: ${{ secrets.M3U_URL != '' }}
        run: |
          set -e
          echo "M3U_URL definido. Tentando baixar M3U remoto..."
          curl -sS -f "${{ secrets.M3U_URL }}" -o lista.m3u || { echo "Falha ao baixar M3U remoto."; rm -f lista.m3u; }

      - name: Choose source EPG
        id: choose_epg
        run: |
          if [ -f epg_remote.xml ]; then
            echo "source=epg_remote.xml" > tmp.txt
          else
            echo "source=epg.xml" > tmp.txt
          fi
          cat tmp.txt
          echo "::set-output name=source::$(cat tmp.txt | cut -d'=' -f2)"

      - name: Run EPG generator (local M3U)
        run: |
          set -e
          source_file="${{ steps.choose_epg.outputs.source }}"
          echo "Rodando gerador com source: source=${source_file}"
          # Ajuste os caminhos/flags conforme seu script precisa
          python3 epg_generator.py --m3u lista.m3u --epg "${source_file}" --out epg.xml

      - name: Preview generated EPG (first 80 lines)
        run: head -n 80 epg.xml || true

      - name: Commit and push epg.xml if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add epg.xml || true
          if ! git diff --staged --quiet --exit-code; then
            git commit -m "Atualiza epg.xml (gerado pelo workflow)" || true
            git push origin HEAD:main
          else
            echo "Nada para commitar"
          fi
